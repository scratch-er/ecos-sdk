#!/usr/bin/env bash
set -euo pipefail

# ECOS `init_project` subcommand
# Initializes a new project from a template

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SDK_ROOT="$(dirname "$SCRIPT_DIR")"

# Color output
log() { echo -e "\033[1;32m[ECOS]\033[0m $*"; }
warn() { echo -e "\033[1;33m[WARN]\033[0m $*"; }
err() { echo -e "\033[1;31m[ERROR]\033[0m $*"; }

echo_available_templates() {
    log "Available project templates:"
    echo "| project_name     | l3 | c1 |"
    echo "|------------------|----|----|"
    echo "| asm_hello        | √  | √  |"
    echo "| asm_gpio         | √  |    |"
    echo "| gpio             |    | √  |"
    echo "| hello            | √  | √  |"
    echo "| i2c_scan         |    | √  |"
    echo "| i2c_sgp30        |    | √  |"
    echo "| minesweeper      |    | √  |"
    echo "| pwm              |    | √  |"
    echo "| spi_st7735       |    | √  |"
    echo "| spi_st7735_clock |    | √  |"
    echo "| spi_st7735_donut |    | √  |"
    echo "|------------------|----|----|"
}

# The actual init_project logic
init_project() {
    local template_name="$1"
    local new_project_name="${2:-$1}"
    local target_board="${3:-}"

    if [[ "$new_project_name" == "" ]]; then
        new_project_name="$template_name"
    fi

    if [[ "$template_name" == "list" ]]; then
        echo_available_templates
        exit 0
    fi

    # Check if project directory exists
    if [[ -d "$new_project_name" ]]; then
        err "Project directory already exists: $new_project_name"
        exit 1
    fi

    # Check if project template exists
    if [[ ! -d "$SDK_ROOT/templates/$template_name" ]]; then
        err "Project template not found: $template_name"
        echo_available_templates
        exit 1
    fi

    # Copy project template from templates directory
    log "Initializing project '$new_project_name' from template '$template_name'..."
    if [[ $template_name == "asm_hello" || $template_name == "asm_gpio" ]]; then

        if [[ ! -d "$SDK_ROOT/templates/$template_name/$target_board" ]]; then
            err "Target project is not supported for board: $target_board"
            echo_available_templates
            exit 1
        fi

        cp -r "$SDK_ROOT/templates/$template_name/$target_board" "$new_project_name"
        cd "$new_project_name"
        echo "BOARD=$target_board" > ".ecos-project"
        echo "TYPE=asm" >> ".ecos-project"
        log "BOARD=$target_board"
        log "Initialized project: $new_project_name"
        log "Config file: .ecos-project"
        log "Project '$new_project_name' created successfully in './$new_project_name'"
        exit 0
    else
        cp -r "$SDK_ROOT/templates/$template_name/$target_board" "$new_project_name"
    fi
    cd "$new_project_name"

    # Initialize project config file
    local board_to_set="${target_board:-c1}"
    echo "BOARD=${board_to_set}" > ".ecos-project"
    log "Initialized project: $new_project_name"
    log "Config file: .ecos-project"

    # Set default board
    ecos set_board "${board_to_set}"

    # Create configs directory and copy scripts
    mkdir -p configs
    cp -r "$SDK_ROOT/tools/scripts/" "."
    log "Project '$new_project_name' created successfully in './$new_project_name'"
}

# Main entry point for the subcommand
if [[ $# -eq 0 ]]; then
    err "Missing project name or 'list' argument"
    echo ""
    echo "Usage: ecos init_project <template_name> [-name new_project_name] [-target target_board]"
    echo "       ecos init_project list"
    echo "Example: ecos init_project hello"
    echo "         ecos init_project hello -name my_new_hello"
    echo "         ecos init_project hello -name my_new_hello -target l3"
    exit 1
fi

template_name=""
new_project_name=""
target_board=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -name)
            new_project_name="$2"
            shift 2
            ;;
        -target)
            target_board="$2"
            shift 2
            ;;
        *)
            if [[ -z "$template_name" ]]; then
                template_name="$1"
                shift
            else
                err "Unknown argument: $1"
                exit 1
            fi
            ;;
    esac
done

if [[ -z "$template_name" ]]; then
    err "Missing template name."
    exit 1
fi

init_project "$template_name" "${new_project_name:-$template_name}" "${target_board:-c1}"
